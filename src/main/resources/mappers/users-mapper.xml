<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="usersMapper"> 
	<update id="updatePwd">
		update users
		set users_pw = #{newPw}
		where users_id = #{usersId} and status = 'Y'
	</update>
	
	<update id="updateInfo">
		update users
		set nickname = #{nickName}, email = #{email}, phone = #{phone}
		where users_id = #{usersId} and status = 'Y'
	</update>
	
	<insert id="insertImage">
		insert into image
		values (seq_image_no.nextval, #{imageDivideNo}, #{imageType}, #{imageOriginalName}, #{imageRenameName}, #{imagePath}, 0)
	</insert>
	
	<update id="updateProfile">
		update users
		set users_selfintro = #{usersSelfIntro}
		where users_no = #{usersNo} and status = 'Y'
	</update>
	
	<select id="selectImage" resultMap="imageResultSet">
		select *
		from image
		where IMAGE_DIVIDE_NO = #{usersNo} and IMAGE_TYPE = 1
	</select>
	
	<resultMap type="Image" id="imageResultSet">
		<id column="IMAGE_NO" property="imageNo"/>
		<result column="IMAGE_DIVIDE_NO" property="imageDivideNo"/>
		<result column="IMAGE_TYPE" property="imageType"/>
		<result column="IMAGE_ORIGINALNAME" property="imageOriginalName"/>
		<result column="IMAGE_RENAMENAME" property="imageRenameName"/>
		<result column="IMAGE_PATH" property="imagePath"/>
		<result column="IMAGE_LEVEL" property="imageLevel"/>
	</resultMap>
	
	<delete id="deleteImage">
		delete from image
		where IMAGE_DIVIDE_NO = #{imageDivideNo} and image_type = '1'
	</delete>
	
	<delete id="deleteImagebase">
		delete from image
		where IMAGE_DIVIDE_NO = #{usersNo} and image_type = '1'
	</delete>
	
	<select id="selectInfo" resultMap="usersResultSet">
		select *
		from users
		where users_no = #{usersNo} and status = 'Y'
	</select>
	
	<resultMap type="Users" id="usersResultSet">
		<id column="USERS_NO" property="usersNo"/>
		<result column="USERS_ID" property="usersId"/>
		<result column="USERS_PW" property="usersPw"/>
		<result column="USERS_NAME" property="usersName"/>
		<result column="NICKNAME" property="nickName"/>
		<result column="EMAIL" property="email"/>
		<result column="PHONE" property="phone"/>
		<result column="ENROLL_DATE" property="enrollDate"/>
		<result column="EXIT_DATE" property="eixtDate"/>
		<result column="STATUS" property="status"/>
		<result column="CHECK_DAY" property="checkDay"/>
		<result column="POINT" property="point"/>
		<result column="IS_ADMIN" property="isAdmin"/>
		<result column="ATTENDANCE_DATE" property="attendanceDate"/>
		<result column="ATTENDANCE_DAY" property="attendanceDay"/>
		<result column="USERS_ADDRESS" property="usersAddress"/>
		<result column="USERS_SELFINTRO" property="usersSelfIntro"/>
	</resultMap>
	
	<update id="deleteInfo">
		update users
		set status = 'N'
		where users_no = #{usersNo} and status = 'Y'
	</update>
	
	<resultMap type="Follow" id="followResultSet">
		<id column="FOLLOW_NO" property="followNo"/>
		<result column="FOLLOWING_USER_NO" property="followingUsersNo"/>
		<result column="FOLLOW_CREATE_DATE" property="followCreateDate"/>
		<result column="USERS_NO" property="usersNo"/>
	</resultMap>
	
	<select id="selectFollowing" resultType="map">
		select follow_no, following_user_no, f.users_no, nickname, image_renamename, social_id, social_profile_img, users_pw, users_id
		from follow f
		     join users u on(u.users_no = following_user_no)
		     left join image on(u.users_no = image_divide_no)
		     left join social_login on (u.users_id = social_id)
		where f.users_no = #{usersNo}
		order by follow_create_date desc
	</select>
	
	<select id="selectFollower" resultType="map">
		select follow_no, following_user_no, f.users_no, nickname, image_renamename, social_id, social_profile_img, users_pw, users_id
		from follow f
		     join users u on(u.users_no = f.users_no)
		     left join image on(u.users_no = image_divide_no)
		     left join social_login on (u.users_id = social_id)
		where f.following_user_no = #{usersNo}
		order by follow_create_date desc
	</select>
	
	<delete id="deleteFollow">
		delete from follow
		where users_no = #{usersNo} and following_user_no = #{followingNo}
	</delete>
	
	<insert id="insertFollow">
		insert into follow
		values(seq_follow_no.nextval, #{followNo}, default, #{usersNo})
	</insert>
	
	<select id="follow" resultType="_int">
		select count(*)
		from follow
		where following_user_no = #{usersNo}
	</select>
	
	<select id="following" resultType="_int">
		select count(*)
		from follow
		where users_no = #{usersNo}
	</select>
	
	<select id="selectMyRecipe" resultMap="recipeResultSet">
		select *
		from recipe
		where users_no = #{usersNo} and recipe_status = 'Y'
		order by food_no desc
	</select>
	
	<resultMap type="Recipe" id="recipeResultSet">
		<id column="food_no" property="foodNo"/>
		<result column="USERS_NO" property="usersNo"/>
		<result column="RECIPE_NAME" property="recipeName"/>
		<result column="CATEGORY_INGREDIENT" property="categoryIngredient"/>
		<result column="CATEGORY_SITUATION" property="categorySituation"/>
		<result column="CATEGORY_TYPE" property="categoryType"/>
		<result column="RECIPE_DIFFICULTY" property="recipeDifficulty"/>
		<result column="RECIPE_TIME" property="recipeTime"/>
		<result column="RECIPE_CONTENT" property="recipeContent"/>
		<result column="RECIPE_COUNT" property="recipeCount"/>
		<result column="RECIPE_CREATE_DATE" property="recipeCreateDate"/>
		<result column="RECIPE_MODIFY_DATE" property="recipeModifyDate"/>
		<result column="RECIPE_STATUS" property="recipeStatus"/>
	</resultMap>
	
	<select id="recipeBookCount" resultType="_int">
		select count(*)
		from bookmark
		where DIVISION_NO = #{foodNo} and number_type = 1
	</select>
	
	<select id="recipeLikeCount" resultType="_int">
		select count(*)
		from likes
		where DIVISION_NO = #{foodNo} and number_type = 1
	</select>
	
	<select id="myBookMarkList" resultType="map">
		select DIVISION_NO, NUMBER_TYPE, i.image_renamename recipe_image, u.nickname, r.recipe_modify_date, r.recipe_name, m.menu_name, h.name, p.PRODUCT_MODIFY_DATE, im.image_renamename menu_image
		from bookmark b
		     left join menu m on (b.division_no = m.product_no)
		     left join healther h on (m.users_no = h.users_no)
		     left join product p on (m.product_no = p.product_no)
		     left join recipe r on (b.division_no = r.food_no)
		     left join image i on (r.food_no = i.IMAGE_DIVIDE_NO)
		     left join image im on (m.product_no = im.image_divide_no)
		     left join users u on (u.users_no = r.users_no)
		where b.users_no = #{usersNo}
		order by bookmark_no desc
	</select>
	
	<select id="myLikeList" resultType="map">
		select l.number_type, nickname, recipe_name, recipe_modify_date, i.image_renamename recipe_image, name, menu_name, product_modify_date, tool_name, mi.image_renamename product_image, product_type, mi.image_type, mi.image_level
		from likes l
		     left join recipe r on (l.division_no = r.food_no)
		     left join users u on (u.users_no = r.users_no)
		     left join image i on (r.food_no = i.image_divide_no)
		     left join menu m on (l.division_no = m.product_no)
		     left join healther h on (m.users_no = h.users_no)
		     left join product p on (l.division_no = p.product_no)
		     left join tool t on (p.product_no = t.product_no)
		     left join image mi on (p.product_no = mi.image_divide_no)
		where l.users_no = #{usersNo}
		order by like_no desc
	</select>
	
	<select id="myFoodLikeList" resultType="map">
		select name, food_name, food_type, image_renamename
		from likes l
		     join product p on (l.division_no = p.product_no) 
		     join healther h on (p.users_no = h.users_no)
		     join food f on (p.product_no = f.product_no)
		     left join image i on (f.product_no = i.image_divide_no) 
		where l.users_no = #{usersNo} and image_level = 1
		order by like_no desc
	</select>
	
</mapper>